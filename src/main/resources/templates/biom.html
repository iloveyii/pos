<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Biometric Login Demo</title>
    <link rel="icon" href="/images/favicon.ico" type="image/x-icon" sizes="any">
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin:0; }
        .card { padding: 2rem; border-radius: 1rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1); width: 320px; }
        input, button { margin: 0.5rem 0; padding: 0.5rem; width: 100%; }
        button { cursor: pointer; }
    </style>
</head>
<body>
<div class="card">
    <h2>üîê Login with Passkey</h2>
    <input id="username" placeholder="Enter username" />
    <button onclick="registerPasskey()">Register Passkey</button>
    <button onclick="loginPasskey()">Login with Passkey</button>
    <p id="status"></p>
</div>

<script>
    // Decode Base64URL to Uint8Array
    function base64urlToUint8Array(base64url) {
        const padding = '='.repeat((4 - base64url.length % 4) % 4);
        const base64 = (base64url + padding)
            .replace(/-/g, '+')
            .replace(/_/g, '/');
        const rawData = atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
    }

    async function registerPasskey() {
        const username = document.getElementById("username").value;
        const options = await fetch("/auth/register-challenge", {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username })
        }).then(res => res.json());

        options.challenge = base64urlToUint8Array(options.challenge);
        options.user.id = base64urlToUint8Array(options.user.id);

        const cred = await navigator.credentials.create({ publicKey: options });

        await fetch("/auth/register-complete", {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, credential: { id: cred.id } })
        });

        document.getElementById("status").innerText = "‚úÖ Passkey registered!";
    }

    async function loginPasskey() {
        const username = document.getElementById("username").value;
        const options = await fetch("/auth/login-challenge", {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username })
        }).then(res => res.json());

        options.challenge = base64urlToUint8Array(options.challenge);
        options.allowCredentials = options.allowCredentials.map(c => ({
            ...c, id: base64urlToUint8Array(c.id)
        }));

        const assertion = await navigator.credentials.get({ publicKey: options });

        await fetch("/auth/login-complete", {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username })
        });

        document.getElementById("status").innerText = "üéâ Logged in successfully!";
    }
</script>
</body>
</html>
